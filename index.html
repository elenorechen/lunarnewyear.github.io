<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 丙午年新春靈籤</title>
    
    <!-- 設定 Open Graph 標籤 -->
    <meta property="og:title" content="2026 丙午年新春靈籤">
    <meta property="og:description" content="誠心祈求，指點迷津。快來抽取您的 2026 年專屬運勢籤詩！">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://images.unsplash.com/photo-1548685913-fe6678b42609?q=80&w=1200&auto=format&fit=crop">

    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 自定義字型與動畫樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Serif TC', serif;
        }

        @keyframes shake {
          0% { transform: translate(1px, 1px) rotate(0deg); }
          10% { transform: translate(-1px, -2px) rotate(-1deg); }
          20% { transform: translate(-3px, 0px) rotate(1deg); }
          30% { transform: translate(3px, 2px) rotate(0deg); }
          40% { transform: translate(1px, -1px) rotate(1deg); }
          50% { transform: translate(-1px, 2px) rotate(-1deg); }
          60% { transform: translate(-3px, 1px) rotate(0deg); }
          70% { transform: translate(3px, 1px) rotate(-1deg); }
          80% { transform: translate(-1px, -1px) rotate(1deg); }
          90% { transform: translate(1px, 2px) rotate(0deg); }
          100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .animate-shake {
          animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
        }
        .writing-vertical {
          writing-mode: vertical-rl;
          text-orientation: upright;
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.8s ease-out forwards;
        }
        @keyframes flipIn {
          0% { opacity: 0; transform: rotateY(90deg) scale(0.8); }
          100% { opacity: 1; transform: rotateY(0) scale(1); }
        }
        .animate-flip-in {
          animation: flipIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
          perspective: 1000px;
        }
        
        .no-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .no-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
    </style>

    <!-- Firebase SDK Setup (Using 10.13.1 for better stability) -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // Global Singleton Key (V8 to ensure fresh start)
        const GLOBAL_FB_KEY = '__2026_FORTUNE_FB_PROMISE_V8__';

        // 立即執行函式，建立全域 Promise
        (function() {
            if (window[GLOBAL_FB_KEY]) return;

            window[GLOBAL_FB_KEY] = new Promise(async (resolve) => {
                // 0. 檢查 Config
                if (typeof window.__firebase_config === 'undefined' || !window.__firebase_config) {
                    console.log("[App] No Firebase Config. Offline Mode.");
                    resolve(null);
                    return;
                }

                try {
                    const firebaseConfig = JSON.parse(window.__firebase_config);
                    let app;
                    
                    // 1. Initialize App (Idempotent)
                    try {
                        if (getApps().length === 0) {
                            app = initializeApp(firebaseConfig);
                        } else {
                            app = getApps()[0]; // Reuse existing app
                        }
                    } catch (e) {
                        console.warn("[App] Firebase App Init Error:", e);
                        resolve(null);
                        return;
                    }

                    const auth = getAuth(app);
                    const appId = window.__app_id || 'default-app-id';

                    // 2. Initialize Firestore (The Risky Part)
                    let db = null;
                    try {
                        // 這裡加上最強力的捕捉，如果有任何錯誤，直接放棄 DB
                        db = getFirestore(app);
                    } catch (err) {
                        console.warn("[App] Firestore Init Failed (Safe Fallback):", err);
                        db = null;
                    }

                    // 3. Handle Auth (Optional but good to have)
                    if (db) {
                        // 只有 DB 成功初始化才需要 Auth
                        await new Promise((authResolve) => {
                            // 設定一個 2 秒超時，避免 Auth 卡住
                            const timer = setTimeout(() => authResolve(null), 2000);

                            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                                clearTimeout(timer);
                                unsubscribe();
                                if (user) {
                                    authResolve(user);
                                } else {
                                    try {
                                        if (window.__initial_auth_token) {
                                            await signInWithCustomToken(auth, window.__initial_auth_token);
                                        } else {
                                            await signInAnonymously(auth);
                                        }
                                    } catch (e) {
                                        console.warn("[App] Auth Failed:", e);
                                    }
                                    authResolve(auth.currentUser);
                                }
                            });
                        });
                    }

                    // 4. Return Result
                    if (db && auth.currentUser) {
                        console.log("[App] Firebase Online.");
                        resolve({ db, appId, auth, user: auth.currentUser, doc, getDoc, setDoc, collection });
                    } else {
                        console.log("[App] Firebase Offline/Fallback Mode.");
                        resolve(null);
                    }

                } catch (e) {
                    console.error("[App] Fatal Firebase Error:", e);
                    resolve(null);
                }
            });
        })();
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Sparkles = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 9h4"/></svg>;
        const Briefcase = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/><rect width="20" height="14" x="2" y="6" rx="2"/></svg>;
        const Heart = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.28 3-2.5 3-4.74 0-2.3-2.1-4.26-4.5-4.26-2.1 0-3.9 1.5-4.5 3.5-.6-2-2.4-3.5-4.5-3.5C3.1 5 1 6.96 1 9.26c0 2.24 1.5 3.46 3 4.74L12 21l8-7z"/></svg>;
        const Home = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const Coins = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></svg>;
        const RotateCcw = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const Share2 = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>;
        const Copy = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const Check = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 6 9 17l-5-5"/></svg>;
        const Gift = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>;
        const Stamp = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>;
        const Info = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
        const X = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;

        // -----------------------------------------------------------------------------
        // Data Configuration
        // -----------------------------------------------------------------------------
        
        // 全場館統一獎項配置
        const DISCOUNTS = [
            { id: 'prize_1', text: '1 元驚喜價', weight: 1, desc: '鴻運當頭！超級大獎' },
            { id: 'prize_bogo', text: '買一送一', weight: 24, desc: '好事成雙！喜事連連' },
            { id: 'prize_combo', text: '物販9折 & 票價7折', weight: 75, desc: '物販商品 9 折 & 常態影片票價 7 折' }
        ];

        const FORTUNES = [
          { level: "大吉", type: "事業", title: "馬到成功", poem: ["千里駿馬遇伯樂", "鵬程萬里展宏圖", "貴人指引登高峰", "事業亨通步步高"], desc: "今年事業運勢如日中天，有晉升或創業的良機，勇往直前必有收穫。", icon: <Briefcase className="w-6 h-6" /> },
          { level: "大吉", type: "愛情", title: "天作之合", poem: ["良緣夙締喜相逢", "月老紅線緊相牽", "花好月圓人長久", "情深意重福滿門"], desc: "單身者將遇見真命天子/天女，有伴者感情甜蜜，適合談婚論嫁。", icon: <Heart className="w-6 h-6" /> },
          { level: "大吉", type: "家庭", title: "闔家安康", poem: ["瑞氣盈門福壽全", "子孫賢孝樂團圓", "家和萬事皆興旺", "喜氣洋洋過好年"], desc: "家庭氣氛和諧，長輩健康，晚輩乖巧，家中應有喜事發生。", icon: <Home className="w-6 h-6" /> },
          { level: "大吉", type: "財運", title: "財源廣進", poem: ["金銀財寶滾滾來", "投資理財眼光開", "正財偏財皆得意", "富貴榮華不需猜"], desc: "財星高照，無論是工作獎金或投資獲利都相當豐厚。", icon: <Coins className="w-6 h-6" /> },
          
          { level: "中吉", type: "事業", title: "穩步高升", poem: ["耕耘數載見花開", "雖然勞碌亦無災", "堅守崗位多努力", "功名利祿自然來"], desc: "工作表現穩定，雖有些許忙碌，但付出都能得到對等的回報。", icon: <Briefcase className="w-6 h-6" /> },
          { level: "中吉", type: "愛情", title: "心心相印", poem: ["即使偶有小風波", "雨過天晴情更多", "互相包容解心結", "琴瑟和鳴樂呵呵"], desc: "感情穩定發展，多溝通能化解小誤會，關係會更加緊密。", icon: <Heart className="w-6 h-6" /> },
          { level: "中吉", type: "家庭", title: "知足常樂", poem: ["平平安安即是福", "莫與他人比財祿", "且看庭前花開落", "家中自有黃金屋"], desc: "生活平順就是最大的福氣，珍惜與家人相處的時光。", icon: <Home className="w-6 h-6" /> },
          { level: "中吉", type: "財運", title: "積沙成塔", poem: ["小財源源不斷流", "節約開支不用愁", "聚沙成塔庫房滿", "穩健經營最優遊"], desc: "財運平穩，適合儲蓄與保守型投資，切勿貪圖暴利。", icon: <Coins className="w-6 h-6" /> },
          
          { level: "小吉", type: "事業", title: "蓄勢待發", poem: ["目前雖在低谷行", "莫灰心志莫停停", "待到春風吹柳綠", "一舉成名天下聞"], desc: "現在是累積實力的時期，保持耐心，機會即將到來。", icon: <Briefcase className="w-6 h-6" /> },
          { level: "小吉", type: "愛情", title: "細水長流", poem: ["緣分未到莫強求", "順其自然解千愁", "若是真心相待處", "春暖花開水長流"], desc: "感情進展較慢，不要急躁，慢慢培養感情會更長久。", icon: <Heart className="w-6 h-6" /> },
          { level: "小吉", type: "家庭", title: "和氣生財", poem: ["瑣碎家事莫計較", "退讓一步樂逍遙", "相互體諒多寬慰", "門庭吉慶喜眉梢"], desc: "家中瑣事較多，多一點包容與體諒，能避免不必要的口角。", icon: <Home className="w-6 h-6" /> },
          { level: "小吉", type: "財運", title: "小有所獲", poem: ["意外之財不可貪", "踏實工作心才安", "量入為出多算計", "自有餘糧在盤餐"], desc: "有些許偏財運，但主要還是靠正財，注意收支平衡。", icon: <Coins className="w-6 h-6" /> },
          
          { level: "末吉", type: "事業", title: "守成不易", poem: ["風浪之中舟難行", "且將帆落待天晴", "謹言慎行防小人", "守得雲開見月明"], desc: "職場風波較多，宜調行事，保守為上，等待時機好轉。", icon: <Briefcase className="w-6 h-6" /> },
          { level: "末吉", type: "愛情", title: "自愛自重", poem: ["落花有意水無情", "何必單戀一枝盈", "修身養性待良緣", "自有佳人伴君行"], desc: "目前緣分未到或有波折，先專注於提升自己，花若盛開蝴蝶自來。", icon: <Heart className="w-6 h-6" /> },
          { level: "末吉", type: "家庭", title: "除舊佈新", poem: ["舊習未除新運阻", "當思變通換門戶", "多行善事積陰德", "枯木逢春再發株"], desc: "家庭可能面臨一些變動或考驗，是改變壞習慣的好時機。", icon: <Home className="w-6 h-6" /> },
          { level: "末吉", type: "財運", title: "謹慎理財", poem: ["錢財身外莫強求", "投資失利令人憂", "安分守己勤耕作", "免得債務上心頭"], desc: "今年財運較弱，切忌借貸與高風險投資，保守儲蓄為上策。", icon: <Coins className="w-6 h-6" /> }
        ];
        
        // 說明事項列表
        const RULES_TEXT = [
            "本活動優惠僅限現場核銷使用，請由工作人員操作，自行點擊核銷或截圖皆視為無效。",
            "每個 Facebook 帳號或裝置限參加一次，優惠券限當日有效。",
            "優惠不得與其他折扣併用，亦不得要求折現或更換其他商品。",
            "贈品數量有限，送完為止，主辦單位保留更換等值贈品之權利。",
            "VOLARE 行動飛行劇院保有活動最終解釋、修改及終止之權利。"
        ];

        // 說明事項元件
        const RulesList = ({ className }) => (
            <ul className={`text-left text-gray-800 text-sm leading-relaxed space-y-2 list-decimal list-outside pl-4 ${className}`}>
                {RULES_TEXT.map((rule, i) => (
                    <li key={i}>{rule}</li>
                ))}
            </ul>
        );

        function App() {
          const [state, setState] = useState('START'); 
          const [fortune, setFortune] = useState(null);
          const [discount, setDiscount] = useState(null);
          const [isRedeemed, setIsRedeemed] = useState(false);
          const [showCopyTip, setShowCopyTip] = useState(false);
          const [tipMessage, setTipMessage] = useState("已複製");
          const [showRules, setShowRules] = useState(false);
          const [isDrawFlow, setIsDrawFlow] = useState(false); // 用於區分是點擊抽籤還是純看規則
          
          // Firebase State
          const [fbContext, setFbContext] = useState(null);
          const [userIP, setUserIP] = useState(null);
          const initRan = useRef(false);

          const TOP_LOGO_URL = "https://i.meee.com.tw/THL1ArX.png";
          const BACKGROUND_URL = "https://i.meee.com.tw/Tww694H.jpg"; 
          const HERO_IMAGE_URL = "https://placehold.co/600x400/8B0000/FFD700?text=2026+New+Year+Hero+Image&font=serif"; 

          // 1. 初始化與還原
          useEffect(() => {
            // A. 立刻檢查 LocalStorage 還原狀態
            const localData = localStorage.getItem('2026_fortune_record');
            if (localData) {
                try {
                    const record = JSON.parse(localData);
                    // 檢查是否有 fortuneIndex (新版)
                    if (record && typeof record.fortuneIndex === 'number' && record.discount) {
                        setFortune(FORTUNES[record.fortuneIndex]);
                        setDiscount(record.discount);
                        setIsRedeemed(record.isRedeemed || false);
                        setState('RESULT');
                        return; // 成功還原，直接結束
                    }
                    if (record && record.fortune && typeof record.fortune === 'object' && record.fortuneIndex === undefined) {
                        localStorage.removeItem('2026_fortune_record');
                    }
                } catch(e) {
                    localStorage.removeItem('2026_fortune_record');
                }
            }

            // B. 如果沒有本地資料，繼續初始化 Firebase
            if (initRan.current) return;
            initRan.current = true;

            const init = async () => {
              let ip = 'unknown';
              try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                ip = data.ip;
              } catch (e) {}
              setUserIP(ip);

              const GLOBAL_FB_KEY = '__2026_FORTUNE_FB_PROMISE_V9__';
              if (window[GLOBAL_FB_KEY]) {
                  try {
                      const fb = await window[GLOBAL_FB_KEY];
                      if (fb) setFbContext(fb);
                  } catch(e) {}
              }
            };
            init();
          }, []);

          // 2. 背景檢查 DB (僅當使用者還在 START 畫面時)
          useEffect(() => {
            if (state !== 'START') return;
            if (!userIP || userIP === 'unknown') return;
            if (!fbContext) return;

            const checkRecord = async () => {
                try {
                  const { db, appId, doc, getDoc } = fbContext;
                  const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'draw_records', userIP);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                    const record = docSnap.data();
                    if (typeof record.fortuneIndex === 'number') {
                        setFortune(FORTUNES[record.fortuneIndex]);
                        setDiscount(record.discount);
                        setIsRedeemed(record.isRedeemed || false);
                        setState('RESULT');
                        // Sync to local
                        localStorage.setItem('2026_fortune_record', JSON.stringify(record));
                    }
                  }
                } catch (e) {}
            };
            checkRecord();
          }, [fbContext, userIP, state]);

          // 開始按鈕點擊處理
          const handleStartClick = () => {
              setIsDrawFlow(true); // 標記為抽籤流程
              setShowRules(true);  // 顯示規則視窗
          };

          // 確認抽籤 (在 Modal 中點擊)
          const confirmDraw = () => {
              setShowRules(false);
              setIsDrawFlow(false);
              drawFortune();
          };

          const drawWithWeight = () => {
            // 使用全場館統一獎池
            const pool = DISCOUNTS;
            const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * totalWeight;
            
            for (const item of pool) {
                if (random < item.weight) {
                    return item;
                }
                random -= item.weight;
            }
            return pool[pool.length - 1]; // Fallback
          };

          const drawFortune = () => {
            setState('ANIMATING');
            setShowCopyTip(false);
            
            setTimeout(async () => {
              const randomIndex = Math.floor(Math.random() * FORTUNES.length);
              const newFortune = FORTUNES[randomIndex];
              const newDiscount = drawWithWeight();
              
              setFortune(newFortune);
              setDiscount(newDiscount);
              setIsRedeemed(false);

              const record = {
                fortuneIndex: randomIndex, // Save Index Only
                discount: newDiscount,
                timestamp: new Date().toISOString(),
                ip: userIP || 'unknown',
                isRedeemed: false
              };

              // 儲存邏輯
              try {
                localStorage.setItem('2026_fortune_record', JSON.stringify(record));
              } catch (e) {}

              if (fbContext && fbContext.db && userIP && userIP !== 'unknown') {
                try {
                  const { db, appId, setDoc, doc } = fbContext;
                  await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'draw_records', userIP), record);
                } catch (e) {}
              }
              
              setState('RESULT');
            }, 3000);
          };

          // 處理核銷
          const handleRedeem = async () => {
              if (window.confirm("是否確定要核銷？\n[為保障您的權益，請交由工作人員確認]")) {
                  setIsRedeemed(true);
                  
                  // 更新紀錄
                  if (fortune && discount) {
                      const record = {
                          fortuneIndex: FORTUNES.indexOf(fortune),
                          discount: discount,
                          timestamp: new Date().toISOString(),
                          ip: userIP || 'unknown',
                          isRedeemed: true
                      };

                      try {
                          const oldData = JSON.parse(localStorage.getItem('2026_fortune_record'));
                          if(oldData && oldData.timestamp) record.timestamp = oldData.timestamp;
                      } catch(e){}

                      localStorage.setItem('2026_fortune_record', JSON.stringify(record));

                      if (fbContext && fbContext.db && userIP && userIP !== 'unknown') {
                          try {
                              const { db, appId, setDoc, doc } = fbContext;
                              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'draw_records', userIP), record, { merge: true });
                          } catch (e) {}
                      }
                  }
              }
          };

          const showTip = (msg) => {
            setTipMessage(msg);
            setShowCopyTip(true);
            setTimeout(() => setShowCopyTip(false), 2500);
          };

          const handleShare = async () => {
            if (!fortune || !discount) return;
            const shareData = {
              title: `2026新春靈籤 - ${fortune.title}`,
              text: `我在2026新春靈籤求到了「${fortune.level}」！\n\n【${fortune.title}】\n${fortune.poem.join('\n')}\n\n★ 新春加碼：${discount.text} (${discount.desc})\n\n解曰：${fortune.desc}\n\n快來求一支你的專屬靈籤吧！`,
              url: window.location.href
            };

            if (navigator.share) {
              try {
                await navigator.share(shareData);
              } catch (err) {
                handleCopy(true);
              }
            } else {
              handleCopy(true);
            }
          };

          const handleCopy = (isFallback = false) => {
            if (!fortune || !discount) return;
            const text = `【${fortune.title}】(${fortune.level})\n${fortune.poem.join('\n')}\n\n★ 新春加碼：${discount.text}\n解曰：${fortune.desc}\n#2026新春靈籤`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).then(() => {
                showTip(isFallback ? "瀏覽器不支援分享，已複製籤文" : "籤文已複製");
              }).catch(err => {
                legacyCopy(text, isFallback);
              });
            } else {
              legacyCopy(text, isFallback);
            }
          };

          const legacyCopy = (text, isFallback) => {
            try {
              const textArea = document.createElement("textarea");
              textArea.value = text;
              textArea.style.top = "0";
              textArea.style.left = "0";
              textArea.style.position = "fixed";
              textArea.style.opacity = "0";
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();
              const successful = document.execCommand('copy');
              document.body.removeChild(textArea);
              
              if (successful) {
                showTip(isFallback ? "瀏覽器不支援分享，已複製籤文" : "籤文已複製");
              } else {
                showTip("複製失敗，請手動截圖");
              }
            } catch (err) {
              showTip("複製失敗，請手動截圖");
            }
          };

          return (
            <div className="min-h-screen bg-[#8B0000] flex flex-col items-center justify-center p-4 font-serif overflow-hidden relative">
              
              {/* 背景圖案 */}
              <div className="absolute inset-0 pointer-events-none">
                {BACKGROUND_URL ? (
                    <img 
                        src={BACKGROUND_URL} 
                        alt="Background Pattern" 
                        className="w-full h-full object-cover opacity-20" 
                    />
                ) : (
                    <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" className="opacity-20">
                      <pattern id="cloud" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                         <path d="M20,50 Q35,35 50,50 T80,50" fill="none" stroke="#FFD700" strokeWidth="2"/>
                         <path d="M10,80 Q35,65 60,80 T100,80" fill="none" stroke="#FFD700" strokeWidth="2"/>
                      </pattern>
                      <rect width="100%" height="100%" fill="url(#cloud)"/>
                    </svg>
                )}
              </div>

              {/* 燈籠 - 已移除 */}

              {/* 標題與 Logo 區域替換為單張圖片 */}
              <div className="z-10 w-full max-w-lg mx-auto mb-8 mt-8 md:mt-12 px-4">
                  <img 
                    src={HERO_IMAGE_URL} 
                    alt="新春主視覺" 
                    className="w-full h-auto object-contain drop-shadow-xl" 
                  />
              </div>

              {/* 互動區 */}
              <div className="z-10 w-full max-w-md aspect-[3/4] flex flex-col items-center justify-center relative mx-auto">
                
                {state === 'START' && (
                  <div className="flex flex-col items-center justify-center w-full h-full animate-fade-in">
                    <div 
                      className="cursor-pointer group relative transition-transform hover:scale-105 active:scale-95"
                      onClick={handleStartClick}
                    >
                      <div className="w-40 h-64 bg-gradient-to-r from-neutral-800 to-neutral-700 rounded-t-lg rounded-b-3xl border-4 border-yellow-600 relative flex justify-center shadow-2xl mx-auto">
                        <div className="absolute top-4 w-full h-8 bg-black/30 border-y border-yellow-600/50"></div>
                        <div className="absolute bottom-10 w-full h-20 bg-red-900/80 flex items-center justify-center border-y-2 border-yellow-500">
                           <div className="w-16 h-16 border-2 border-yellow-500 rotate-45 flex items-center justify-center">
                              <span className="text-yellow-400 font-bold text-2xl -rotate-45">簽</span>
                           </div>
                        </div>
                        <div className="absolute -top-8 w-2 h-12 bg-yellow-100 border border-yellow-700 rounded-t transform -rotate-12 left-10"></div>
                        <div className="absolute -top-6 w-2 h-10 bg-yellow-100 border border-yellow-700 rounded-t transform rotate-6 right-12"></div>
                        <div className="absolute -top-10 w-2 h-14 bg-yellow-100 border border-yellow-700 rounded-t transform -rotate-3 left-16 z-0"></div>
                      </div>
                      
                      <div className="mt-8 px-8 py-3 bg-gradient-to-r from-yellow-500 to-yellow-700 text-white text-xl font-bold rounded-full shadow-lg border-2 border-yellow-300 flex items-center gap-2 group-hover:shadow-[0_0_20px_rgba(255,215,0,0.6)] transition-all mx-auto">
                        <Sparkles className="w-5 h-5 animate-pulse" />
                        點擊求籤
                        <Sparkles className="w-5 h-5 animate-pulse" />
                      </div>
                    </div>
                  </div>
                )}

                {state === 'ANIMATING' && (
                  <div className="flex flex-col items-center justify-center w-full h-full">
                    <div className="animate-shake w-40 h-64 bg-gradient-to-r from-neutral-800 to-neutral-700 rounded-t-lg rounded-b-3xl border-4 border-yellow-600 relative flex justify-center shadow-2xl mx-auto">
                        <div className="absolute bottom-10 w-full h-20 bg-red-900/80 flex items-center justify-center border-y-2 border-yellow-500">
                           <div className="w-16 h-16 border-2 border-yellow-500 rotate-45 flex items-center justify-center">
                              <span className="text-yellow-400 font-bold text-2xl -rotate-45">運</span>
                           </div>
                        </div>
                        <div className="absolute -top-10 left-1/2 -translate-x-1/2">
                           <div className="flex gap-2 animate-bounce">
                             <div className="w-2 h-16 bg-yellow-100 border border-yellow-700 rounded-t"></div>
                             <div className="w-2 h-12 bg-yellow-100 border border-yellow-700 rounded-t mt-4"></div>
                             <div className="w-2 h-14 bg-yellow-100 border border-yellow-700 rounded-t mt-2"></div>
                           </div>
                        </div>
                    </div>
                    <p className="mt-8 text-yellow-300 text-xl font-bold animate-pulse text-center">誠心祈求中...</p>
                  </div>
                )}

                {state === 'RESULT' && fortune && (
                  <div className="animate-flip-in w-full max-w-sm bg-[#FFFDF5] rounded-lg shadow-[0_0_40px_rgba(255,215,0,0.3)] overflow-hidden border-8 border-double border-red-800 relative flex flex-col mx-auto h-full max-h-full">
                    <div className="absolute top-0 left-0 w-16 h-16 border-t-4 border-l-4 border-red-800 rounded-tl-lg z-10 pointer-events-none"></div>
                    <div className="absolute top-0 right-0 w-16 h-16 border-t-4 border-r-4 border-red-800 rounded-tr-lg z-10 pointer-events-none"></div>
                    <div className="absolute bottom-0 left-0 w-16 h-16 border-b-4 border-l-4 border-red-800 rounded-bl-lg z-10 pointer-events-none"></div>
                    <div className="absolute bottom-0 right-0 w-16 h-16 border-b-4 border-r-4 border-red-800 rounded-br-lg z-10 pointer-events-none"></div>

                    <div className="p-6 pb-24 flex flex-col items-center text-center flex-1 overflow-y-auto no-scrollbar bg-[url('https://www.transparenttextures.com/patterns/rice-paper.png')]">
                      
                      {/* 運勢標籤 */}
                      <div className="mb-4 relative shrink-0">
                        <div className="absolute inset-0 bg-red-600 transform rotate-3 rounded blur-sm opacity-50"></div>
                        <div className={`relative px-6 py-2 text-3xl font-bold text-white border-2 border-yellow-400 shadow-md ${
                          fortune.level === '大吉' ? 'bg-red-600' :
                          fortune.level === '中吉' ? 'bg-orange-600' :
                          'bg-yellow-600' // Catch all for 小吉 and 末吉
                        }`}>
                          {fortune.level}
                        </div>
                      </div>

                      <div className="flex items-center justify-center gap-2 text-red-800 mb-6 shrink-0">
                        {fortune.icon}
                        <span className="text-xl font-bold tracking-widest border-b-2 border-red-800 pb-1">{fortune.type}籤</span>
                      </div>

                      <h2 className="text-2xl font-bold text-black mb-6 tracking-[0.2em] shrink-0">{fortune.title}</h2>

                      <div className="w-full space-y-3 mb-6 shrink-0">
                        {fortune.poem.map((line, idx) => (
                          <p key={idx} className="text-lg md:text-xl font-medium text-gray-800 font-serif leading-relaxed border-l-4 border-red-800/20 pl-4 text-left mx-auto max-w-[80%]">
                            {line}
                          </p>
                        ))}
                      </div>
                      
                      <div className="w-16 h-0.5 bg-red-800/30 mb-4 shrink-0"></div>

                      <div className="bg-red-50 p-4 rounded text-left w-full border border-red-100 mb-4 shrink-0">
                        <p className="text-red-900 text-sm md:text-base leading-relaxed">
                          <span className="font-bold bg-red-200 px-1 rounded text-red-800 mr-2">解曰</span>
                          {fortune.desc}
                        </p>
                      </div>

                      {/* 折扣顯示區 (含核銷功能) */}
                      {discount && (
                        <div className={`w-full mb-4 shrink-0 animate-fade-in ${isRedeemed ? 'opacity-70 grayscale' : ''}`} style={{animationDelay: '0.3s'}}>
                          <div className={`relative overflow-hidden rounded-lg border-2 ${isRedeemed ? 'border-gray-400 bg-gray-100' : (discount.weight === 1 ? 'border-yellow-400 bg-red-600' : 'border-red-200 bg-white')} shadow-md p-3`}>
                            {/* 閃光特效 (僅限 1% 大獎且未核銷) */}
                            {!isRedeemed && discount.weight === 1 && (
                              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse pointer-events-none"></div>
                            )}
                            
                            <div className="flex items-center gap-3">
                              <div className={`p-2 rounded-full ${isRedeemed ? 'bg-gray-300 text-gray-500' : (discount.weight === 1 ? 'bg-yellow-400 text-red-700' : 'bg-red-100 text-red-600')}`}>
                                <Gift className="w-6 h-6" />
                              </div>
                              <div className="text-left flex-1">
                                <div className={`text-xs font-bold mb-0.5 ${isRedeemed ? 'text-gray-500' : (discount.weight === 1 ? 'text-yellow-300' : 'text-red-400')}`}>
                                  {isRedeemed ? '已使用' : '新春加碼紅包 (限當次使用)'}
                                </div>
                                <div className={`text-xl font-bold ${isRedeemed ? 'text-gray-600 line-through' : (discount.weight === 1 ? 'text-white' : 'text-red-800')}`}>
                                  {discount.text}
                                </div>
                              </div>
                            </div>

                            {/* 核銷按鈕區 */}
                            <div className="mt-2 pt-2 border-t border-dashed border-gray-300 flex justify-end">
                                {isRedeemed ? (
                                    <span className="text-xs font-bold text-gray-500 bg-gray-200 px-2 py-1 rounded">已核銷</span>
                                ) : (
                                    <button 
                                        onClick={handleRedeem}
                                        className={`text-xs font-bold px-3 py-1.5 rounded border transition-colors ${discount.weight === 1 
                                            ? 'bg-yellow-400 text-red-900 border-yellow-500 hover:bg-yellow-300' 
                                            : 'bg-white text-red-600 border-red-300 hover:bg-red-50'}`}
                                    >
                                        工作人員核銷
                                    </button>
                                )}
                            </div>

                            {/* 裝飾印章 */}
                            <div className="absolute -right-2 -bottom-2 w-16 h-16 border-4 border-red-500/20 rounded-full flex items-center justify-center transform -rotate-12 pointer-events-none">
                               <span className="text-red-500/20 font-bold text-xs">{isRedeemed ? '已兌換' : '大吉大利'}</span>
                            </div>
                          </div>
                        </div>
                      )}

                      <div className="flex flex-col w-full gap-3 mt-auto shrink-0 relative z-20">
                        
                        {showCopyTip && (
                           <div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-gray-900/90 text-white text-sm py-2 px-4 rounded-lg whitespace-nowrap animate-fade-in shadow-xl z-50 flex items-center gap-2">
                             <Check className="w-4 h-4 text-green-400" />
                             {tipMessage}
                           </div>
                         )}

                        <div className="flex gap-2 w-full">
                          <button 
                            onClick={handleShare}
                            className="flex-1 bg-yellow-500 hover:bg-yellow-600 text-red-900 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 shadow-sm transition-colors"
                          >
                            <Share2 className="w-5 h-5" />
                            分享好運
                          </button>

                          <button 
                            onClick={() => handleCopy(false)}
                            className="bg-red-100 hover:bg-red-200 text-red-800 font-bold py-2 px-3 rounded-lg flex items-center justify-center shadow-sm transition-colors"
                            title="複製籤文"
                          >
                             <Copy className="w-5 h-5" />
                          </button>
                        </div>
                      </div>

                      {/* 在結果頁面底部再次顯示注意事項 */}
                      <div className="mt-6 w-full text-center">
                           <div className="bg-white/50 p-4 rounded-lg border border-red-200">
                               <h4 className="font-bold text-red-800 mb-2 flex items-center justify-center gap-1">
                                   <Info className="w-4 h-4" />
                                   活動注意事項
                               </h4>
                               <RulesList className="text-xs" />
                           </div>
                      </div>

                    </div>
                  </div>
                )}
              </div>

              {/* 活動注意事項 & 版權 (移至最下方) */}
              {state === 'START' && (
                  <div className="mt-8 text-center z-10 w-full max-w-sm mx-auto flex flex-col items-center gap-4">
                      <button 
                          onClick={() => setShowRules(true)}
                          className="flex items-center gap-1.5 text-yellow-300/80 hover:text-yellow-200 text-xs border border-yellow-500/30 rounded-full px-3 py-1 bg-black/20 backdrop-blur-sm transition-colors"
                      >
                          <Info className="w-3.5 h-3.5" />
                          活動注意事項
                      </button>

                      <div className="text-yellow-500/40 text-xs">
                        © 2026 VOLARE 行動飛行劇院丙午年春節限定 · 祝您新春愉快 萬事如意
                      </div>
                  </div>
              )}

              {/* 注意事項 Modal */}
              {showRules && (
                  <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                      {/* 背景遮罩 */}
                      <div 
                          className="absolute inset-0 bg-black/70 backdrop-blur-sm animate-fade-in"
                          onClick={() => {
                              // 如果不是在抽籤流程中，點擊背景可以關閉
                              // 如果是抽籤流程，建議強制點擊按鈕，但為了體驗也可以允許關閉
                              setShowRules(false);
                              if(isDrawFlow) setIsDrawFlow(false);
                          }}
                      ></div>
                      
                      {/* 視窗本體 */}
                      <div className="bg-white w-full max-w-md rounded-xl shadow-2xl relative z-10 animate-flip-in overflow-hidden border-4 border-red-800">
                          {/* 標題 */}
                          <div className="bg-red-800 text-yellow-400 p-4 flex justify-between items-center">
                              <h3 className="font-bold text-lg flex items-center gap-2">
                                  <Info className="w-5 h-5" />
                                  活動注意事項
                              </h3>
                              <button onClick={() => {
                                  setShowRules(false);
                                  if(isDrawFlow) setIsDrawFlow(false);
                              }} className="text-yellow-400/80 hover:text-white transition-colors">
                                  <X className="w-6 h-6" />
                              </button>
                          </div>
                          
                          {/* 內容 */}
                          <div className="p-6 text-gray-800 text-sm leading-relaxed space-y-3 max-h-[60vh] overflow-y-auto">
                              <RulesList />
                          </div>

                          {/* 底部按鈕區 (根據是否為抽籤流程切換) */}
                          <div className="p-4 bg-gray-50 border-t border-gray-200 text-center">
                              {isDrawFlow ? (
                                  <div className="flex flex-col gap-3">
                                      <p className="text-xs text-gray-500 font-medium">
                                          我已詳閱並同意以上說明
                                      </p>
                                      <button 
                                          onClick={confirmDraw}
                                          className="bg-red-800 hover:bg-red-900 text-white px-6 py-3 rounded-lg font-bold text-lg transition-colors w-full flex items-center justify-center gap-2 shadow-lg"
                                      >
                                          <Sparkles className="w-5 h-5" />
                                          看籤詩
                                      </button>
                                  </div>
                              ) : (
                                  <button 
                                      onClick={() => setShowRules(false)}
                                      className="bg-stone-200 hover:bg-stone-300 text-stone-700 px-6 py-2 rounded-lg font-bold transition-colors w-full"
                                  >
                                      我已了解
                                  </button>
                              )}
                          </div>
                      </div>
                  </div>
              )}

            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>